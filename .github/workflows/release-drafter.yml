name: Release Drafter

on:
    push:
        branches:
            - master
        paths-ignore:
            - "VERSION"
            - "README.md"

jobs:
    bump:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout the source code
              uses: actions/checkout@v2

            - name: Bump Version
              uses: remorses/bump-version@js
              with:
                  version_file: VERSION
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    draft:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout the source code
              uses: actions/checkout@v2

            - name: Release Drafter
              id: release_drafter
              uses: release-drafter/release-drafter@v5
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Get version
              id: get_version
              run: echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}

            - name: Pack files
              uses: thedoctor0/zip-release@master
              with:
                  filename: "MalFramework_v${{ steps.get_version.outputs.VERSION }}.zip"
                  exclusions: "*.git* /tools/* .editorconfig .gitignore"

            - name: Upload release asset
              uses: actions/upload-release-asset@v1.0.1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.release_drafter.outputs.upload_url }}
                  asset_path: ./MalFramework_v${{ steps.get_version.outputs.VERSION }}.zip
                  asset_name: MalFramework_v${{ steps.get_version.outputs.VERSION }}.zip
                  asset_content_type: application/zip
